---
export interface Props {
  formId: string;
  title?: string;
  description?: string;
  className?: string;
  height?: string;
  width?: string;
  style?: 'inline' | 'modal' | 'popup';
}

const {
  formId,
  title,
  description,
  className = '',
  height = '600px',
  width = '100%',
  style = 'inline'
} = Astro.props;
---

<div class={`ghl-form-wrapper ${className}`}>
  {title && <h2 class="text-2xl font-bold mb-4">{title}</h2>}
  {description && <p class="text-gray-600 mb-6">{description}</p>}

  {style === 'inline' ? (
    <div
      class="ghl-form-embed"
      data-form-id={formId}
      style={`width: ${width}; min-height: ${height}; position: relative;`}
    >
      <iframe
        src={`https://api.leadconnectorhq.com/widget/form/${formId}`}
        style="width: 100%; height: 100%; border: none;"
        id={`ghl-form-${formId}`}
        title={title || 'Contact Form'}
        scrolling="no"
      />
    </div>
  ) : (
    <button
      class="btn btn-primary"
      data-ghl-form={formId}
      data-ghl-style={style}
    >
      Open Form
    </button>
  )}
</div>

<script>
  const formButtons = document.querySelectorAll('[data-ghl-form]');

  formButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      const target = e.target as HTMLButtonElement;
      const formId = target.dataset.ghlForm;
      const style = target.dataset.ghlStyle;

      if (style === 'modal') {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-lg max-w-2xl w-full mx-4 relative">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            <div class="p-6">
              <iframe
                src="https://api.leadconnectorhq.com/widget/form/${formId}"
                style="width: 100%; height: 600px; border: none;"
                title="Contact Form"
              />
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => {
          if (e.target === modal || (e.target as HTMLElement).closest('button')) {
            modal.remove();
          }
        });
      } else if (style === 'popup') {
        window.open(
          `https://api.leadconnectorhq.com/widget/form/${formId}`,
          'ghl-form',
          'width=600,height=700'
        );
      }
    });
  });

  // Auto-resize iframes based on content
  const iframes = document.querySelectorAll('.ghl-form-embed iframe');
  iframes.forEach(iframe => {
    (iframe as HTMLIFrameElement).onload = function() {
      try {
        const height = (iframe as HTMLIFrameElement).contentDocument?.body.scrollHeight;
        if (height) {
          (iframe as HTMLIFrameElement).style.height = height + 'px';
        }
      } catch (e) {
        console.log('Could not auto-resize iframe (cross-origin)');
      }
    };
  });
</script>